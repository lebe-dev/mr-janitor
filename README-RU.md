# Mr.Janitor

Утилита для очистки ненужных файлов с гибкой конфигурацией.

## С чего начать / Getting started

Создайте конфигурационный файл `janitor.conf`:

```
cp janitor.conf-distrib janitor.conf 
```

### Очистка ненужных файлов / Clean Up

Очистка ненужных файлов:

```bash
java -jar janitor.jar cleanup
```

### Холостой запуск / Dry run

В режим холостого запуска утилита отображает объекты для очистки, ничего не удаляет из файловой системы.

```
java -jar janitor.jar dry-run
```

Пример вывода:

```
profile 'site'
- path: '/backups/super-important-site'
- storage-unit: directory
- keep copies: 3
directory items for clean up (4):
- '2019-07-19'
  - files: 51
  - valid: true
  - last-modified: Fri Jul 19 20:25:53 MSK 2019
- '2019-07-20'
  - files: 50
  - valid: false
  - last-modified: Sat Jul 20 20:23:48 MSK 2019
---
items total: 3

```

## Конфигурация

Janitor читает конфигурацию из файла `janitor.conf`.

Секция `defaults` определяет настройки по умолчанию. В случае если в профиле не определена какая-либо из опций, то
значение подгружается из профиля по умолчанию.

### 1. Сколько объектов оставлять

Вы можете указать сколько объектов вы хотите оставлять в файловой системе. Как это сделать:

```
someProfile {
    keep-items-quantity = 7
}
```

## Умные проверки / Smart Checks

Janitor включает в себя несколько встроенных проверок чтобы убедиться какие данные валидные, а какие нет.
Например, zip архивы можно проверять на целостность стандартными средствами. Объекты к которым прилагается md5-файл
с hash-суммой можно проверить сравнением хэшей.

Больше примеров с комментариями вы можете найти в файле `janitor.conf-distrib`.

### Проверки для режима хранения - DIRECTORY

Свойство `unit` подсказывает для утилиты с каким видом объектов утилита имеет дело.

Видов бывает два:

- `DIRECTORY` - директория с файлами
- `FILE` - файлы

Для директорий есть несколько проверок.

#### 1. Общий размер должен быть не менее чем у предыдущей директории

Как включить:

```
item-validation {
    directory {
        size-at-least-as-previous = true
    }
}
```

#### 2. Количество файлов должно быть не меньше чем в предыдущей директории

Как включить:

```
item-validation {
    directory {
        files-qty-at-least-as-in-previous = true
    }
}
```

#### 3. Размер каждого файла должен быть не меньше аналогичного файла из предыдущей директории

```
item-validation {
    directory {
        file-size-at-least-as-in-previous = true
    }
}
```

### Проверки для режима хранения - FILE

#### 1. Размер текущего файла должен быть не меньше чем у предыдущего, если имеется

Как включить:

```
item-validation {
    file {
        size-at-least-as-previous = true
    }
}
```

#### 2. Проверка md5-сумм

Janitor ищет файл-компаньон с расширением `.md5` и сверяет хэш-суммы. Например, если текущий файл 
называется `abc.zip`, то утилита ожидает файл `abc.zip.md5`.

Как включить:

```
item-validation {
    file {
        md5-file-check = true
    }
}
```

#### 3. Проверка целостности zip-архива

Подходит только для zip-архивов.

Как включить:

```
item-validation {
    file {
        zip-test = true
    }
}
```

#### 4. Проверка - log-файл существует

Janitor ищет файл-компаньон с расширением `log`. Например, если текущий файл называется `site.dmp`, то утилита
ищет файл `site.dmp.log`.

Как включить:

```
item-validation {
    file {
        log-file-exists = true
    }
}
```

#### 5. Проверка с помощью внешней команды

Janitor поддерживает проверку с помощью внешних команд. 

Как это включить:

```
item-validation {
    file {
        use-custom-validator = true
        custom-validator-command = "gzip -t ${fileName}"
    }
}
```

В примере будет запущена команда `gzip` с флагом `-t` и вместо записи `${fileName}` будет подставлено имя текущего
файла.

## Политики очитски

Вы можете определить политику очистки ненужных файлов для каждого из профилей, либо общую в профиле 
по умолчанию (defaults).

По умолчанию Janitor удалит все устаревшие но валидные файлы. Для невалидных можно выбрать правила обработки.

### Правило - Удалить все некорректные объекты

Как это включить:

```
someProfile {
    cleanup {      
        all-invalid-items = true
    }
}
```

### Не удалять некорректные объекты в диапазоне хранения

Под диапазоном хранения понимается опция `keep-items-quantity`.

Бывают сиутации когда некорректные объекты, особенно директории, могут иметь ценность несмотря неполные данные.

Если вы хотите сохранять такие объекты в рамках `keep-items-quantity` вот как это можно настроить:

```
someProfile {
    cleanup {
        invalid-items-beyond-of-keep-quantity = true
        all-invalid-items = false
    }
}
```

Эта опция зависит от `all-invalid-items`, последняя имеет приоритет выше.

## Road map

- Обнаруживать предыдущие файловые объекты с помощью регулярных выражений